<!DOCTYPE html>
<html lang="pt-br" class="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planejador de Orçamento — Histórico</title>

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        darkMode: 'class',
        theme: { extend: {} }
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>

  <body class="bg-[#111a22] dark:bg-[#0a1015] transition-colors duration-300" style='font-family: Inter, "Noto Sans", sans-serif'>
  <script src="../js/auth-protection.js"></script>
  <div class="relative flex min-h-screen w-full overflow-x-hidden">
      <!-- Sidebar -->
      <aside class="w-[310px] shrink-0 bg-[#1a2a38]/95 border-r border-white/10 shadow-[0_0_0_1px_rgba(255,255,255,0.04),0_10px_30px_rgba(0,0,0,0.35)] backdrop-blur supports-[backdrop-filter]:backdrop-blur sticky top-0 h-screen">
        <div class="p-5 flex flex-col h-full">
          <div class="flex flex-col items-center gap-3">
            <div id="avatarPreview" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-24 w-24 ring-2 ring-white/10" style='background-image:url("../imagens/usuario.jpg");'></div>
            <div class="text-center">
              <p class="text-white text-lg font-bold leading-tight" id="nomeTopo">Usuário exemplo</p>
              <p class="text-[#b9cee3] text-sm" id="statusTopo">Online</p>
            </div>
            <a href="/MenuPrincipal/TelaEditarPerfil.html" class="mt-1 inline-flex items-center justify-center h-9 px-4 rounded-lg bg-[#1773cf] text-white text-sm font-semibold hover:bg-[#1773cf]/90 transition">Editar Perfil</a>
          </div>

          <div class="mt-6">
            <h1 class="text-white text-sm font-medium">Planejador de Orçamento</h1>
            <p class="text-[#9fbbd4] text-xs">v1.0</p>
          </div>

          <nav class="mt-4 grid gap-1" id="sidebar">
            <a href="/MenuPrincipal/TelaMenuPrincipal.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 256 256" fill="currentColor"><path d="M218.83,103.3,141.17,33.33a16,16,0,0,0-22.34,0L37.17,103.3A16,16,0,0,0,32,114.64V208a16,16,0,0,0,16,16H96a8,8,0,0,0,8-8V160h48v56a8,8,0,0,0,8,8h48a16,16,0,0,0,16-16V114.64A16,16,0,0,0,218.83,103.3Z"/></svg>
              </span>
              <span class="text-white text-sm font-medium">Home</span>
            </a>

            <a href="/MenuPrincipal/RegistrarEmpresa.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M239.73,208H224V96a16,16,0,0,0-16-16H164a4,4,0,0,0-4,4V208H144V32.41a16.43,16.43,0,0,0-6.16-13,16,16,0,0,0-18.72-.69L39.12,72A16,16,0,0,0,32,85.34V208H16.27A8.18,8.18,0,0,0,8,215.47,8,8,0,0,0,16,224H240a8,8,0,0,0,8-8.53A8.18,8.18,0,0,0,239.73,208Z"/></svg></span>
              <span class="text-white text-sm font-medium">Registrar cliente</span>
            </a>

            <a href="/MenuPrincipal/RegistrarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34Z"/></svg></span>
              <span class="text-white text-sm font-medium">Registrar serviço</span>
            </a>

            <a href="/MenuPrincipal/AgendarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Z"/></svg></span>
              <span class="text-white text-sm font-medium">Agendar serviço</span>
            </a>

            <a href="/MenuPrincipal/VerHistorico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg bg-[#243647] ring-1 ring-white/10">
              <span class="text-white"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 5a1 1 0 0 0-2 0v5c0 .265.105.52.293.707l3 3a1 1 0 1 0 1.414-1.414L13 11.586V7z"/></svg></span>
              <span class="text-white text-sm font-medium">Ver histórico</span>
            </a>

            <a href="/MenuPrincipal/CriarOrcamento.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"/></svg></span>
              <span class="text-white text-sm font-medium">Criar plano de orçamento</span>
            </a>
          </nav>

          <div class="mt-auto pt-4">
            <a href="#" data-logout="true" class="w-full inline-flex items-center justify-center h-10 px-4 rounded-lg bg-white/10 text-white font-semibold hover:bg-white/20 transition">Sair</a>
          </div>
        </div>
      </aside>

      <!-- Conteúdo -->
      <main class="flex-1 max-w-[1100px] w-full mx-auto px-6 py-8">
        <div class="flex items-end justify-between">
          <div>
            <h2 class="text-white text-2xl font-bold">Histórico</h2>
            <p class="text-[#93adc8] mt-1">Todos os agendamentos e orçamentos.</p>
          </div>
          <input id="inp-busca" placeholder="Pesquisar..." class="form-input h-10 w-56 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" />
        </div>

        <!-- Tabs -->
        <div class="mt-6 border-b border-white/10">
          <div class="flex gap-6">
            <button id="tab-agendamentos" class="pb-3 text-white font-medium border-b-2 border-[#1773cf]">
              Agendamentos
            </button>
            <button id="tab-orcamentos" class="pb-3 text-[#93adc8] font-medium hover:text-white transition">
              Orçamentos
            </button>
          </div>
        </div>

        <!-- Tabela de Agendamentos -->
        <div id="content-agendamentos" class="mt-6">
          <div class="overflow-hidden rounded-xl border border-white/10">
            <table class="min-w-full divide-y divide-white/10">
              <thead class="bg-white/5">
                <tr class="text-[#b9cee3] text-sm">
                  <th class="px-4 py-3 text-left font-medium">Data/Hora</th>
                  <th class="px-4 py-3 text-left font-medium">Serviço</th>
                  <th class="px-4 py-3 text-left font-medium">Valor</th>
                  <th class="px-4 py-3 text-left font-medium">Adicionado por</th>
                  <th class="px-4 py-3 text-left font-medium">Adicionado em</th>
                  <th class="px-4 py-3 text-left font-medium">Status</th>
                </tr>
              </thead>
              <tbody id="tbody-agendamentos" class="divide-y divide-white/5 text-white/90"></tbody>
            </table>
          </div>
          <div id="empty-agendamentos" class="mt-4 hidden">
            <p class="text-white/70">Nenhum agendamento encontrado.</p>
          </div>
        </div>

        <!-- Tabela de Orçamentos -->
        <div id="content-orcamentos" class="mt-6 hidden">
          <div class="overflow-hidden rounded-xl border border-white/10">
            <table class="min-w-full divide-y divide-white/10">
              <thead class="bg-white/5">
                <tr class="text-[#b9cee3] text-sm">
                  <th class="px-4 py-3 text-left font-medium">Data</th>
                  <th class="px-4 py-3 text-left font-medium">Cliente</th>
                  <th class="px-4 py-3 text-left font-medium">Valor Total</th>
                  <th class="px-4 py-3 text-left font-medium">Status</th>
                  <th class="px-4 py-3 text-left font-medium">Ações</th>
                </tr>
              </thead>
              <tbody id="tbody-orcamentos" class="divide-y divide-white/5 text-white/90"></tbody>
            </table>
          </div>
          <div id="empty-orcamentos" class="mt-4 hidden">
            <p class="text-white/70">Nenhum orçamento encontrado.</p>
          </div>
        </div>
      </main>
    </div>

    <!-- Script de proteção de autenticação -->
    <script src="/js/auth-protection.js"></script>
    
    <script>
      const $tbody = document.getElementById('tbody');
      const $busca = document.getElementById('inp-busca');
      const $empty = document.getElementById('empty');

      function moeda(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v||0)); }
      function fmtDataHoraISO(iso){
        const d = new Date(iso);
        if (isNaN(d)) return '-';
        const dd = d.toLocaleDateString('pt-BR');
        const hh = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        return dd+' '+hh;
      }
      function fmtDataHora(iso){
        const d = new Date(iso);
        if (isNaN(d)) return '-';
        const dd = d.toLocaleDateString('pt-BR');
        const hh = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        return dd+' '+hh;
      }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      // ====== TABS LOGIC ======
      const $tabAgendamentos = document.getElementById('tab-agendamentos');
      const $tabOrcamentos = document.getElementById('tab-orcamentos');
      const $contentAgendamentos = document.getElementById('content-agendamentos');
      const $contentOrcamentos = document.getElementById('content-orcamentos');
      const $tbodyAgendamentos = document.getElementById('tbody-agendamentos');
      const $tbodyOrcamentos = document.getElementById('tbody-orcamentos');
      const $emptyAgendamentos = document.getElementById('empty-agendamentos');
      const $emptyOrcamentos = document.getElementById('empty-orcamentos');

      let abaAtual = 'agendamentos';

      function ativarAba(aba) {
        abaAtual = aba;
        if (aba === 'agendamentos') {
          $tabAgendamentos.classList.add('text-white', 'border-[#1773cf]');
          $tabAgendamentos.classList.remove('text-[#93adc8]');
          $tabOrcamentos.classList.remove('text-white', 'border-[#1773cf]');
          $tabOrcamentos.classList.add('text-[#93adc8]');
          $contentAgendamentos.classList.remove('hidden');
          $contentOrcamentos.classList.add('hidden');
        } else {
          $tabOrcamentos.classList.add('text-white', 'border-[#1773cf]');
          $tabOrcamentos.classList.remove('text-[#93adc8]');
          $tabAgendamentos.classList.remove('text-white', 'border-[#1773cf]');
          $tabAgendamentos.classList.add('text-[#93adc8]');
          $contentOrcamentos.classList.remove('hidden');
          $contentAgendamentos.classList.add('hidden');
        }
      }
      $tabAgendamentos.addEventListener('click', () => { ativarAba('agendamentos'); });
      $tabOrcamentos.addEventListener('click', () => { ativarAba('orcamentos'); });
      ativarAba('agendamentos');

      // ====== API FUNCTIONS ======
      async function carregarAgendamentos() {
        try {
          const params = new URLSearchParams();
          if ($busca.value.trim()) params.append('busca', $busca.value.trim());
          const response = await fetch(`/api/agendamentos/?${params}`, { credentials: 'include' });
          if (!response.ok) throw new Error('Erro ao carregar agendamentos');
          const data = await response.json();
          renderAgendamentos(data.agendamentos);
        } catch (error) {
          $tbodyAgendamentos.innerHTML = '<tr><td class="px-4 py-6 text-center text-red-300" colspan="6">Erro ao carregar dados</td></tr>';
        }
      }
      function renderAgendamentos(agendamentos) {
        const q = ($busca.value||'').trim().toLowerCase();
        let rows = agendamentos.filter(a =>
          !q || (a.servico_nome || '').toLowerCase().includes(q) || (a.usuario_nome || '').toLowerCase().includes(q)
        );
        rows.sort((a,b)=> new Date(b.data_hora) - new Date(a.data_hora));
        $tbodyAgendamentos.innerHTML = '';
        rows.forEach(a => {
          const cancelado = a.status === 'Cancelado';
          const concluido = a.status === 'Concluído';
          let statusHtml = '<span class="text-emerald-300">Agendado</span>';
          if (cancelado) statusHtml = '<span class="text-red-300 font-semibold">CANCELADO</span>';
          else if (concluido) statusHtml = '<span class="text-green-300 font-semibold">CONCLUÍDO</span>';
          const tr = document.createElement('tr');
          if (cancelado) tr.classList.add('opacity-60');
          tr.innerHTML = `
            <td class="px-4 py-3">${fmtDataHoraISO(a.data_hora)}</td>
            <td class="px-4 py-3">${escapeHtml(a.servico_nome || '-')}</td>
            <td class="px-4 py-3">${moeda(a.valor)}</td>
            <td class="px-4 py-3">${escapeHtml(a.usuario_nome || '-')}</td>
            <td class="px-4 py-3">${fmtDataHora(a.created_at)}</td>
            <td class="px-4 py-3 flex items-center gap-2">${statusHtml}
              <a href="/MenuPrincipal/AgendarServico.html?id=${a.id_agendamento}" class="ml-2 text-[#1773cf] hover:underline whitespace-nowrap">Detalhes</a>
            </td>
          `;
          $tbodyAgendamentos.appendChild(tr);
        });
        $emptyAgendamentos.classList.toggle('hidden', rows.length > 0);
        if (rows.length === 0 && agendamentos.length > 0) {
          $emptyAgendamentos.classList.add('hidden');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-4 py-6 text-center text-white/60" colspan="6">Nenhum resultado para "${escapeHtml($busca.value||'')}".</td>`;
          $tbodyAgendamentos.appendChild(tr);
        }
      }
      async function carregarOrcamentos() {
        try {
          const params = new URLSearchParams();
          if ($busca.value.trim()) params.append('busca', $busca.value.trim());
          const response = await fetch(`/api/orcamentos/?${params}`, { credentials: 'include' });
          if (!response.ok) throw new Error('Erro ao carregar orçamentos');
          const data = await response.json();
          renderOrcamentos(data.orcamentos || []);
        } catch (error) {
          $tbodyOrcamentos.innerHTML = '<tr><td class="px-4 py-6 text-center text-red-300" colspan="5">Erro ao carregar dados</td></tr>';
        }
      }
      function renderOrcamentos(orcamentos) {
        const q = ($busca.value||'').trim().toLowerCase();
        let rows = orcamentos.filter(o => {
          const c = o.orcamento;
          return !q || (c.cliente_nome || '').toLowerCase().includes(q) || (c.status || '').toLowerCase().includes(q);
        });
        rows.sort((a,b)=> new Date(b.orcamento.data_criacao) - new Date(a.orcamento.data_criacao));
        $tbodyOrcamentos.innerHTML = '';
        rows.forEach(o => {
          const c = o.orcamento;
          let statusHtml = '<span class="text-emerald-300">'+escapeHtml(c.status)+'</span>';
          if (c.status === 'Recusado') statusHtml = '<span class="text-red-300 font-semibold">RECUSADO</span>';
          else if (c.status === 'Aprovado') statusHtml = '<span class="text-green-300 font-semibold">APROVADO</span>';
          else if (c.status === 'Concluído') statusHtml = '<span class="text-blue-300 font-semibold">CONCLUÍDO</span>';
          $tbodyOrcamentos.innerHTML += `
            <tr>
              <td class="px-4 py-3">${fmtDataHoraISO(c.data_criacao)}</td>
              <td class="px-4 py-3">${escapeHtml(c.cliente_nome || '-')}</td>
              <td class="px-4 py-3">${moeda(c.valor_total)}</td>
              <td class="px-4 py-3">${statusHtml}</td>
              <td class="px-4 py-3">
                <a href="/MenuPrincipal/DetalheOrcamento.html?id=${c.id_orcamento}" class="text-[#1773cf] hover:underline mr-2">Detalhes</a>
                <a href="/api/orcamentos/${c.id_orcamento}/pdf" target="_blank" class="text-[#1773cf] hover:underline">PDF</a>
              </td>
            </tr>
          `;
        });
        $emptyOrcamentos.classList.toggle('hidden', rows.length > 0);
        if (rows.length === 0 && orcamentos.length > 0) {
          $emptyOrcamentos.classList.add('hidden');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-4 py-6 text-center text-white/60" colspan="5">Nenhum resultado para "${escapeHtml($busca.value||'')}".</td>`;
          $tbodyOrcamentos.appendChild(tr);
        }
      }
      // Busca e recarrega ao trocar de aba ou digitar
      $busca.addEventListener('input', () => {
        if (abaAtual === 'agendamentos') carregarAgendamentos();
        else carregarOrcamentos();
      });
      $tabAgendamentos.addEventListener('click', carregarAgendamentos);
      $tabOrcamentos.addEventListener('click', carregarOrcamentos);
      // Inicialização
      carregarAgendamentos();
    </script>
  </body>
</html>
