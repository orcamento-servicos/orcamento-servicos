<!DOCTYPE html>
<html lang="pt-br" class="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planejador de Orçamento — Registrar Empresa</title>

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        darkMode: 'class',
        theme: { extend: {} }
      };
      document.addEventListener('DOMContentLoaded', function() {
        const telefoneEmpresaInput = document.getElementById('telefoneEmpresa');
        if (telefoneEmpresaInput) {
          telefoneEmpresaInput.addEventListener('input', function(e) {
            let v = telefoneEmpresaInput.value.replace(/\D/g, '');
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length >= 2) {
              v = '(' + v.slice(0,2) + ') ' + v.slice(2);
            }
            if (v.length > 9) {
              v = v.slice(0,10) + '-' + v.slice(10);
            }
            telefoneEmpresaInput.value = v;
          });
        }
      });
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>

  <body class="bg-[#111a22] dark:bg-[#0a1015] transition-colors duration-300" style='font-family: Inter, "Noto Sans", sans-serif'>
  <div class="relative flex min-h-screen w-full overflow-x-hidden">
      <!-- SIDEBAR -->
      <aside class="w-[310px] shrink-0 bg-[#1a2a38]/95 border-r border-white/10 shadow-[0_0_0_1px_rgba(255,255,255,0.04),0_10px_30px_rgba(0,0,0,0.35)] backdrop-blur supports-[backdrop-filter]:backdrop-blur sticky top-0 h-screen">
        <div class="p-5 flex flex-col h-full">
          <!-- Perfil -->
          <div class="flex flex-col items-center gap-3">
            <div id="avatarPreview" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-24 w-24 ring-2 ring-white/10" style='background-image:url("../imagens/usuario.jpg");'></div>
            <div class="text-center">
              <p class="text-white text-lg font-bold leading-tight" id="nomeTopo">Usuário exemplo</p>
              <p class="text-[#b9cee3] text-sm" id="statusTopo">Online</p>
            </div>
            <a href="/MenuPrincipal/TelaEditarPerfil.html"
               class="mt-1 inline-flex items-center justify-center h-9 px-4 rounded-lg bg-[#1773cf] text-white text-sm font-semibold hover:bg-[#1773cf]/90 transition">
              Editar Perfil
            </a>
          </div>

          <!-- Info -->
          <div class="mt-6">
            <h1 class="text-white text-sm font-medium">Planejador de Orçamento</h1>
            <p class="text-[#9fbbd4] text-xs">v1.0</p>
          </div>

          <!-- Menu -->
          <nav class="mt-4 grid gap-1" id="sidebar">
            <!-- HOME -->
            <a href="/MenuPrincipal/TelaMenuPrincipal.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- ícone: casa -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 256 256" fill="currentColor" aria-hidden="true">
                  <path d="M218.83,103.3,141.17,33.33a16,16,0,0,0-22.34,0L37.17,103.3A16,16,0,0,0,32,114.64V208a16,16,0,0,0,16,16H96a8,8,0,0,0,8-8V160h48v56a8,8,0,0,0,8,8h48a16,16,0,0,0,16-16V114.64A16,16,0,0,0,218.83,103.3Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Home</span>
            </a>

            <a href="RegistrarCliente.html" class="menu-item group text-left flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- prédios -->
           <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256" aria-hidden="true">
           <path d="M239.73,208H224V96a16,16,0,0,0-16-16H164a4,4,0,0,0-4,4V208H144V32.41a16.43,16.43,0,0,0-6.16-13,16,16,0,0,0-18.72-.69L39.12,72A16,16,0,0,0,32,85.34V208H16.27A8.18,8.18,0,0,0,8,215.47,8,8,0,0,0,16,224H240a8,8,0,0,0,8-8.53A8.18,8.18,0,0,0,239.73,208Z"/>
           </svg>
              </span>
              <span class="text-white text-sm font-medium">Registrar cliente</span>
            </a>

            <a href="/MenuPrincipal/RegistrarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- arquivo -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Registrar serviço</span>
            </a>

            <a href="/MenuPrincipal/AgendarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- calendário -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Agendar serviço</span>
            </a>

            <a href="/MenuPrincipal/VerHistorico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- relógio sólido (branco) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 5a1 1 0 0 0-2 0v5c0 .265.105.52.293.707l3 3a1 1 0 1 0 1.414-1.414L13 11.586V7z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Ver histórico</span>
            </a>

            <a href="/MenuPrincipal/CriarOrcamento.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- plus -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Criar plano de orçamento</span>
            </a>
          </nav>

          <!-- Sair -->
          <div class="mt-auto pt-4">
            <a
              href="#"
              data-logout="true"
              class="w-full inline-flex items-center justify-center h-10 px-4 rounded-lg bg-white/10 text-white font-semibold hover:bg-white/20 transition"
            >
              Sair
            </a>
          </div>
        </div>
      </aside>

      <!-- CONTEÚDO -->
      <main class="flex-1 max-w-[1100px] w-full mx-auto px-6 py-8">
        <h2 class="text-white text-2xl font-bold">Registrar Empresa</h2>
        <p class="text-[#93adc8] mt-1">Cadastre os dados da sua empresa para aparecer nos orçamentos.</p>

        <!-- FORMULÁRIO DE EMPRESA NO TOPO -->
        <form id="formEmpresa" class="mt-6 grid max-w-xl gap-4">
          <input id="nomeEmpresa" placeholder="Nome da empresa" class="form-input h-12 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" required autocomplete="off" />
          <input id="cnpjEmpresa" placeholder="CNPJ" class="form-input h-12 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" required maxlength="18" autocomplete="off" />
          <input id="telefoneEmpresa" placeholder="Telefone" class="form-input h-12 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" required maxlength="15" autocomplete="off" />
          <input id="enderecoEmpresa" placeholder="Endereço" class="form-input h-12 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" required />
          <input id="emailEmpresa" placeholder="E-mail" type="email" class="form-input h-12 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" required />
          <div>
            <label for="logoEmpresa" class="block text-white mb-1">Logo da empresa (opcional)</label>
            <input id="logoEmpresa" type="file" accept="image/*" class="form-input h-12 rounded-lg border-none bg-[#243647] text-white" />
          </div>
          <div class="flex items-center justify-between">
            <p id="alertEmpresa" class="text-sm text-white/70"></p>
            <button type="submit" class="h-10 px-4 rounded-lg bg-[#1773cf] text-white font-bold">Salvar empresa</button>
          </div>
        </form>

        <!-- CAMPO DE PESQUISA E LISTA DE EMPRESAS -->
        <div class="mt-10">
          <div class="flex items-end justify-between">
            <div>
              <h3 class="text-white text-xl font-semibold">Buscar empresa</h3>
              <p class="text-[#93adc8] text-sm mt-1">Digite o nome e pressione Enter ou clique em Pesquisar.</p>
            </div>
            <div class="flex gap-2">
              <input id="inp-busca-empresa" placeholder="Pesquisar empresa..." class="form-input h-10 w-56 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" />
              <button id="btn-pesquisar-empresa" class="h-10 px-4 rounded-lg bg-[#1773cf] text-white font-bold">Pesquisar</button>
            </div>
          </div>

          <div class="mt-4 overflow-hidden rounded-xl border border-white/10">
            <table class="min-w-full divide-y divide-white/10">
              <thead class="bg-white/5">
                <tr class="text-[#b9cee3] text-sm">
                  <th class="px-4 py-3 text-left font-medium">Empresa</th>
                  <th class="px-4 py-3 text-left font-medium">CNPJ</th>
                  <th class="px-4 py-3 text-left font-medium">Telefone</th>
                  <th class="px-4 py-3 text-left font-medium">Endereço</th>
                  <th class="px-4 py-3 text-left font-medium">E-mail</th>
                  <th class="px-4 py-3 text-right font-medium">Ações</th>
                </tr>
              </thead>
              <tbody id="tbody-empresas" class="divide-y divide-white/5 text-white/90">
                <!-- itens gerados via JS -->
              </tbody>
            </table>
          </div>

          <!-- VAZIO -->
          <div id="empty-state-empresa" class="mt-4 hidden">
            <p class="text-white/70">Nenhuma empresa cadastrada ainda.</p>
          </div>
        </div>

      </main>
    </div>

    <!-- Script de proteção de autenticação -->
    <script src="/js/auth-protection.js"></script>
    <script>
      (function () {
        const formEmpresa = document.getElementById('formEmpresa');
        const alertEmpresa = document.getElementById('alertEmpresa');
        const buscaEmpresa = document.getElementById('inp-busca-empresa');
        const btnPesquisarEmpresa = document.getElementById('btn-pesquisar-empresa');
        const tbodyEmpresas = document.getElementById('tbody-empresas');
        const emptyEmpresa = document.getElementById('empty-state-empresa');
        let empresasCache = [];

        function setAlert(message, ok = false) {
          alertEmpresa.textContent = message;
          alertEmpresa.className = ok
            ? 'bg-emerald-600/10 text-emerald-300 p-4 rounded-md mt-2'
            : 'bg-red-600/10 text-red-300 p-4 rounded-md mt-2';
        }

        formEmpresa.addEventListener('submit', async (e) => {
          e.preventDefault();
          const nome = document.getElementById('nomeEmpresa').value.trim();
          const cnpj = document.getElementById('cnpjEmpresa').value.trim();
          const telefone = document.getElementById('telefoneEmpresa').value.trim();
          const endereco = document.getElementById('enderecoEmpresa').value.trim();
          const email = document.getElementById('emailEmpresa').value.trim();
          const logoInput = document.getElementById('logoEmpresa');
          const logoFile = logoInput && logoInput.files.length > 0 ? logoInput.files[0] : null;

          if (/[0-9]/.test(nome)) {
            setAlert('O nome não pode conter números.');
            return;
          }
          const cnpjNumeros = cnpj.replace(/\D/g, '');
          if (cnpjNumeros.length !== 14) {
            setAlert('CNPJ inválido. Informe 14 dígitos.');
            return;
          }
          const telefoneNumeros = telefone.replace(/\D/g, '');
          if (telefoneNumeros.length !== 11) {
            setAlert('Telefone inválido. Informe 11 dígitos (com DDD).');
            return;
          }
          const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
          if (!emailRegex.test(email)) {
            setAlert('E-mail inválido. Informe um e-mail válido.');
            return;
          }

          try {
            const formData = new FormData();
            formData.append('nome', nome);
            formData.append('cnpj', cnpjNumeros);
            formData.append('telefone', telefoneNumeros);
            formData.append('endereco', endereco);
            formData.append('email', email);
            if (logoFile) {
              formData.append('logo', logoFile);
            }
            const response = await fetch('/api/empresas/', {
              method: 'POST',
              credentials: 'include',
              body: formData
            });
            const data = await response.json().catch(() => null);
            if (!response.ok) {
              throw new Error((data && (data.erro || data.mensagem)) || 'Erro ao salvar empresa');
            }
            setAlert('Empresa cadastrada com sucesso!', true);
            formEmpresa.reset();
            await carregarEmpresas();
          } catch (err) {
            setAlert(err.message || 'Erro ao salvar empresa');
          }
        });

        function escapeHtml(s) {
          return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        async function carregarEmpresas() {
          try {
            const response = await fetch('/api/empresas/', {
              method: 'GET',
              credentials: 'include'
            });
            if (response.ok) {
              const data = await response.json();
              empresasCache = data.empresas || [];
              renderizarEmpresas(empresasCache, buscaEmpresa.value);
            } else {
              empresasCache = [];
              renderizarEmpresas([], buscaEmpresa.value);
            }
          } catch (error) {
            empresasCache = [];
            renderizarEmpresas([], buscaEmpresa.value);
          }
        }

        function renderizarEmpresas(empresas, filtro = '') {
          const filtroLower = filtro.toLowerCase();
          let empresasFiltradas = empresas.filter(empresa => 
            empresa.nome.toLowerCase().includes(filtroLower) ||
            (empresa.cnpj && empresa.cnpj.toLowerCase().includes(filtroLower)) ||
            (empresa.email && empresa.email.toLowerCase().includes(filtroLower)) ||
            (empresa.telefone && empresa.telefone.toLowerCase().includes(filtroLower)) ||
            (empresa.endereco && empresa.endereco.toLowerCase().includes(filtroLower))
          );
          if (filtro && empresasFiltradas.length > 0) {
            empresasFiltradas = [empresasFiltradas[0]];
          }
          tbodyEmpresas.innerHTML = '';
          emptyEmpresa.classList.toggle('hidden', empresasFiltradas.length > 0);
          if (empresasFiltradas.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td colspan="6" class="px-4 py-6 text-center text-white/60">
                Nenhum resultado encontrado para "${escapeHtml(filtro)}"
              </td>
            `;
            tbodyEmpresas.appendChild(tr);
            return;
          }
          empresasFiltradas.forEach(empresa => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="px-4 py-3 font-bold">${escapeHtml(empresa.nome)}</td>
              <td class="px-4 py-3">${escapeHtml(empresa.cnpj || '')}</td>
              <td class="px-4 py-3">${escapeHtml(empresa.telefone || '')}</td>
              <td class="px-4 py-3">${escapeHtml(empresa.endereco || '')}</td>
              <td class="px-4 py-3">${escapeHtml(empresa.email || '')}</td>
              <td class="px-4 py-3 text-right">
                <a href="/MenuPrincipal/EditarEmpresa.html?id=${empresa.id_empresa}" class="inline-flex items-center gap-2 h-9 px-3 mr-2 rounded-lg bg-[#1773cf] hover:bg-[#1773cf]/80 text-white text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 256 256" fill="currentColor"><path d="M227.31,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A16,16,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A16,16,0,0,0,104,219.31l123.31-123.31A16,16,0,0,0,227.31,73.37Z"/></svg>
                  Editar
                </a>
                <button data-del="${empresa.id_empresa}" class="inline-flex items-center gap-2 h-9 px-3 rounded-lg bg-red-600/80 hover:bg-red-700 text-white text-sm font-bold">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                    <path d="M216,56H168V40a24,24,0,0,0-24-24H112A24,24,0,0,0,88,40V56H40a8,8,0,0,0,0,16h8V208a24,24,0,0,0,24,24H184a24,24,0,0,0,24-24V72h8a8,8,0,0,0,0-16ZM104,40a8,8,0,0,1,8-8h32a8,8,0,0,1,8,8V56H104ZM192,208a8,8,0,0,1-8,8H72a8,8,0,0,1-8-8V72H192Z"/>
                  </svg>
                  Excluir
                </button>
              </td>
            `;
            tbodyEmpresas.appendChild(tr);
          });
        }

        tbodyEmpresas.addEventListener('click', async (e) => {
          const btn = e.target.closest('button[data-del]');
          if (!btn) return;
          const id = btn.getAttribute('data-del');
          if (!confirm('Tem certeza que deseja excluir esta empresa?')) return;
          btn.disabled = true;
          btn.textContent = 'Excluindo...';
          try {
            const response = await fetch(`/api/empresas/${id}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (response.ok) {
              await carregarEmpresas();
            }
          } finally {
            btn.disabled = false;
            btn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                <path d="M216,56H168V40a24,24,0,0,0-24-24H112A24,24,0,0,0,88,40V56H40a8,8,0,0,0,0,16h8V208a24,24,0,0,0,24,24H184a24,24,0,0,0,24-24V72h8a8,8,0,0,0,0-16ZM104,40a8,8,0,0,1,8-8h32a8,8,0,0,1,8,8V56H104ZM192,208a8,8,0,0,1-8,8H72a8,8,0,0,1-8-8V72H192Z"/>
              </svg>
              Excluir
            `;
          }
        });

        btnPesquisarEmpresa.addEventListener('click', () => renderizarEmpresas(empresasCache, buscaEmpresa.value));
        buscaEmpresa.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            renderizarEmpresas(empresasCache, buscaEmpresa.value);
          }
        });

        carregarEmpresas();

        // Marca o item ativo no menu
        const currentLast = (location.pathname || '').split('/').pop() || '';
        document.querySelectorAll('#sidebar .menu-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          const hrefLast = href.split('/').pop() || '';
          if (href === location.pathname || hrefLast === currentLast) {
            a.classList.add('bg-[#243647]', 'ring-1', 'ring-white/10');
          }
        });
      })();
    </script>
  </body>
</html>
