<!DOCTYPE html>
<html lang="pt-br" class="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planejador de Or√ßamento ‚Äî Criar Plano</title>

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        darkMode: 'class',
        theme: { extend: {} }
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>

  <body class="bg-[#111a22] dark:bg-[#0a1015] transition-colors duration-300" style='font-family: Inter, "Noto Sans", sans-serif'>
  <script src="../js/auth-protection.js"></script>
  <div class="relative flex min-h-screen w-full overflow-x-hidden">
      <!-- Sidebar -->
      <aside class="w-[310px] shrink-0 bg-[#1a2a38]/95 border-r border-white/10 shadow-[0_0_0_1px_rgba(255,255,255,0.04),0_10px_30px_rgba(0,0,0,0.35)] backdrop-blur supports-[backdrop-filter]:backdrop-blur sticky top-0 h-screen">
        <div class="p-5 flex flex-col h-full">
          <div class="flex flex-col items-center gap-3">
            <div id="avatarPreview" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-24 w-24 ring-2 ring-white/10" style='background-image:url("../imagens/usuario.jpg");'></div>
            <div class="text-center">
              <p class="text-white text-lg font-bold leading-tight" id="nomeTopo">Usu√°rio exemplo</p>
              <p class="text-[#b9cee3] text-sm" id="statusTopo">Online</p>
            </div>
            <a href="/MenuPrincipal/TelaEditarPerfil.html" class="mt-1 inline-flex items-center justify-center h-9 px-4 rounded-lg bg-[#1773cf] text-white text-sm font-semibold hover:bg-[#1773cf]/90 transition">Editar Perfil</a>
          </div>

          <div class="mt-6">
            <h1 class="text-white text-sm font-medium">Planejador de Or√ßamento</h1>
            <p class="text-[#9fbbd4] text-xs">v1.0</p>
          </div>

          <nav class="mt-4 grid gap-1" id="sidebar">
            <!-- HOME -->
            <a href="/MenuPrincipal/TelaMenuPrincipal.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- √≠cone: casa -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 256 256" fill="currentColor" aria-hidden="true">
                  <path d="M218.83,103.3,141.17,33.33a16,16,0,0,0-22.34,0L37.17,103.3A16,16,0,0,0,32,114.64V208a16,16,0,0,0,16,16H96a8,8,0,0,0,8-8V160h48v56a8,8,0,0,0,8,8h48a16,16,0,0,0,16-16V114.64A16,16,0,0,0,218.83,103.3Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Home</span>
            </a>

            <a href="RegistrarCliente.html" class="menu-item group text-left flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- pr√©dios -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M239.73,208H224V96a16,16,0,0,0-16-16H164a4,4,0,0,0-4,4V208H144V32.41a16.43,16.43,0,0,0-6.16-13,16,16,0,0,0-18.72-.69L39.12,72A16,16,0,0,0,32,85.34V208H16.27A8,8,0,0,0,8,215.47,8,8,0,0,0,16,224H240a8,8,0,0,0,8-8.53A8,8,0,0,0,239.73,208Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Registrar cliente</span>
            </a>

            <a href="/MenuPrincipal/RegistrarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- arquivo -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Registrar servi√ßo</span>
            </a>

            <a href="/MenuPrincipal/AgendarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- calend√°rio -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Agendar servi√ßo</span>
            </a>

            <a href="/MenuPrincipal/VerHistorico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <!-- rel√≥gio s√≥lido (branco) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 5a1 1 0 0 0-2 0v5c0 .265.105.52.293.707l3 3a1 1 0 1 0 1.414-1.414L13 11.586V7z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Ver hist√≥rico</span>
            </a>

            <a href="/MenuPrincipal/CriarOrcamento.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg bg-[#243647] ring-1 ring-white/10">
              <span class="text-white">
                <!-- plus -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Criar plano de or√ßamento</span>
            </a>
          </nav>

          <!-- Sair -->
          <div class="mt-auto pt-4">
            <a
              href="/"
              data-logout="true"
              class="w-full inline-flex items-center justify-center h-10 px-4 rounded-lg bg-white/10 text-white font-semibold hover:bg-white/20 transition"
            >
              Sair
            </a>
          </div>
        </div>
      </aside>

      <!-- Conte√∫do -->
      <main class="flex-1 max-w-[1100px] w-full mx-auto px-6 py-8">
        <h2 class="text-white text-2xl font-bold">Criar Plano de Or√ßamento</h2>
        <p class="text-[#93adc8] mt-1">Selecione empresa, servi√ßos e os dados do cliente para gerar um PDF.</p>

        <!-- SELE√á√ÉO DE EMPRESA COM PESQUISA -->
        <section class="mt-6 grid gap-3 max-w-4xl">
          <h3 class="text-white font-semibold">Empresa</h3>
          <div class="relative">
            <input 
              id="inp-empresa" 
              type="text" 
              placeholder="Procure o nome da empresa..." 
              class="form-input h-11 w-full rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" 
            />
            <!-- Dropdown de sugest√µes -->
            <div id="dropdown-empresas" class="absolute top-full left-0 right-0 mt-1 bg-[#243647] border border-white/10 rounded-lg shadow-lg max-h-80 overflow-y-auto hidden z-50">
              <!-- preenchido via JS -->
            </div>
          </div>
          <p id="warn-empresa" class="text-amber-300 text-sm hidden">‚ö†Ô∏è Nenhuma empresa cadastrada. Cadastre em "Registrar empresa".</p>
          <div id="empresa-selecionada" class="text-sm text-white/70 hidden">Empresa selecionada: <span id="empresa-selecionada-nome" class="text-white font-medium">‚Äî</span></div>
        </section>

        <!-- SELE√á√ÉO DE CLIENTE COM PESQUISA -->
        <section class="mt-6 grid gap-3 max-w-4xl">
          <h3 class="text-white font-semibold">Cliente</h3>
          <div class="relative">
            <input 
              id="inp-cliente" 
              type="text" 
              placeholder="Procure o nome do cliente..." 
              class="form-input h-11 w-full rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" 
            />
            <!-- Dropdown de sugest√µes -->
            <div id="dropdown-clientes" class="absolute top-full left-0 right-0 mt-1 bg-[#243647] border border-white/10 rounded-lg shadow-lg max-h-80 overflow-y-auto hidden z-50">
              <!-- preenchido via JS -->
            </div>
          </div>
          <p id="warn-cliente" class="text-amber-300 text-sm hidden">‚ö†Ô∏è Nenhum cliente cadastrado. Cadastre em "Registrar cliente".</p>
          <div id="cliente-selecionado" class="text-sm text-white/70 hidden">Cliente selecionado: <span id="cliente-selecionado-nome" class="text-white font-medium">‚Äî</span></div>
        </section>

        <!-- SELE√á√ÉO DE SERVI√áOS -->
        <section class="mt-8 grid gap-3 max-w-4xl">
          <div class="flex items-center justify-between">
            <h3 class="text-white font-semibold">Servi√ßos</h3>
            <input id="inp-busca-serv" placeholder="Pesquisar servi√ßos..." class="form-input h-10 w-64 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8]" />
          </div>
          <div id="lista-servicos" class="grid md:grid-cols-2 gap-3">
            <!-- checkboxes via JS -->
          </div>
          <p id="warn-serv" class="text-amber-300 text-sm hidden">‚ö†Ô∏è Nenhum servi√ßo cadastrado. Cadastre em ‚ÄúRegistrar servi√ßo‚Äù.</p>
        </section>

        <!-- DADOS DO CLIENTE -->
        <section class="mt-8 grid md:grid-cols-2 gap-6 max-w-4xl">
          <div class="grid gap-3">
            <h3 class="text-white font-semibold">Dados do Cliente</h3>
            <div id="dados-cliente" class="rounded-lg border border-white/10 bg-white/5 p-4 space-y-2">
              <p class="text-[#b9cee3] text-sm">Nome: <span id="cliente-nome" class="text-white/90">‚Äî</span></p>
              <p class="text-[#b9cee3] text-sm">Telefone: <span id="cliente-telefone" class="text-white/90">‚Äî</span></p>
              <p class="text-[#b9cee3] text-sm">E-mail: <span id="cliente-email" class="text-white/90">‚Äî</span></p>
              <p class="text-[#b9cee3] text-sm">Endere√ßo: <span id="cliente-endereco" class="text-white/90">‚Äî</span></p>
            </div>
          </div>
          <div class="grid gap-3">
            <h3 class="text-white font-semibold">Resumo do Or√ßamento</h3>
            <div class="rounded-lg border border-white/10 bg-white/5 p-4 space-y-2">
              <p class="text-[#b9cee3] text-sm">Empresa emissora: <span id="prev-empresa" class="text-white/90">‚Äî</span></p>
              <p class="text-[#b9cee3] text-sm">Cliente: <span id="prev-cliente" class="text-white/90">‚Äî</span></p>
              <p class="text-[#b9cee3] text-sm">Servi√ßos selecionados: <span id="prev-qtd" class="text-white/90">0</span></p>
              <p class="text-[#b9cee3] text-sm">Total estimado: <span id="prev-total" class="text-white font-semibold">R$ 0,00</span></p>
            </div>
          </div>
        </section>

        <!-- A√á√ïES -->
        <section class="mt-6 flex flex-wrap items-center justify-between gap-3 max-w-4xl">
          <p id="msg" class="text-sm text-white/70"></p>
          <div class="flex gap-2">
            <button id="btn-pdf" class="h-10 px-4 rounded-lg bg-[#1773cf] text-white font-bold">Gerar PDF</button>
          </div>
        </section>

        <!-- PREVIEW TABELA DOS SERVI√áOS -->
        <section class="mt-6 rounded-xl border border-white/10 bg-white/5 p-5 max-w-4xl">
          <h4 class="text-white font-semibold mb-3">Servi√ßos selecionados</h4>
          <div class="overflow-auto">
            <table class="min-w-full divide-y divide-white/10">
              <thead class="bg-white/5">
                <tr class="text-[#b9cee3] text-sm">
                  <th class="px-4 py-2 text-left font-medium">Servi√ßo</th>
                  <th class="px-4 py-2 text-left font-medium">Descri√ß√£o</th>
                  <th class="px-4 py-2 text-right font-medium">Pre√ßo</th>
                </tr>
              </thead>
              <tbody id="tbody-preview" class="divide-y divide-white/5 text-white/90">
                <!-- via JS -->
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <!-- Script de prote√ß√£o de autentica√ß√£o -->
    <script src="/js/auth-protection.js"></script>
    
    <script>
      // Elementos
      const $inpEmpresa = document.getElementById('inp-empresa');
      const $dropdownEmpresas = document.getElementById('dropdown-empresas');
      const $empresaSelecionadaDiv = document.getElementById('empresa-selecionada');
      const $empresaSelecionadaNome = document.getElementById('empresa-selecionada-nome');
      const $warnEmpresa = document.getElementById('warn-empresa');
      const $inpCliente = document.getElementById('inp-cliente');
      const $dropdownClientes = document.getElementById('dropdown-clientes');
      const $clienteSelecionadoDiv = document.getElementById('cliente-selecionado');
      const $clienteSelecionadoNome = document.getElementById('cliente-selecionado-nome');
      const $listaServ = document.getElementById('lista-servicos');
      const $btnPdf = document.getElementById('btn-pdf');
      const $warnCliente = document.getElementById('warn-cliente');
      const $warnServ = document.getElementById('warn-serv');
      const $msg = document.getElementById('msg');
      const $clienteNome = document.getElementById('cliente-nome');
      const $clienteTelefone = document.getElementById('cliente-telefone');
      const $clienteEmail = document.getElementById('cliente-email');
      const $clienteEndereco = document.getElementById('cliente-endereco');
      const $prevCliente = document.getElementById('prev-cliente');
      const $prevQtd = document.getElementById('prev-qtd');
      const $prevTotal = document.getElementById('prev-total');
      const $prevEmpresa = document.getElementById('prev-empresa');
      const $tbodyPrev = document.getElementById('tbody-preview');

      function showMsg(text, ok = true) {
        if (!$msg) return console.log(text);
        $msg.textContent = text;
        $msg.className = 'text-sm ' + (ok ? 'text-emerald-300' : 'text-red-300');
        setTimeout(() => { $msg.textContent = ''; $msg.className = 'text-sm text-white/70'; }, 2200);
      }

      function moeda(v) { return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(Number(v||0)); }
      function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      // Empresas
      let cacheEmpresas = [];
      let empresaSelecionada = null;

      async function carregarEmpresas() {
        if (!$warnEmpresa) return;
        try {
          const res = await fetch(`${API_BASE_URL}/empresas/`, { credentials: 'include' });
          if (!res.ok) {
            showMsg('N√£o foi poss√≠vel carregar empresas', false);
            $warnEmpresa.classList.remove('hidden');
            return;
          }
          const data = await res.json();
          cacheEmpresas = data.empresas || [];
          $warnEmpresa.classList.toggle('hidden', cacheEmpresas.length > 0);
        } catch (err) {
          console.error(err);
          showMsg('Erro ao carregar empresas', false);
          $warnEmpresa.classList.remove('hidden');
        }
      }

      function filtrarEmpresas(termo) {
        const q = (termo || '').trim().toLowerCase();
        const lista = q
          ? cacheEmpresas.filter(e =>
          e.nome.toLowerCase().includes(q) ||
          (e.cnpj && e.cnpj.toLowerCase().includes(q)) ||
          (e.email && e.email.toLowerCase().includes(q))
        )
          : cacheEmpresas;
        return lista.slice(0, 15);
      }

      function renderDropdownEmpresas(termo) {
        if (!$dropdownEmpresas) return;
        const filtradas = filtrarEmpresas(termo);
        $dropdownEmpresas.innerHTML = '';
        if (filtradas.length === 0) {
          $dropdownEmpresas.classList.add('hidden');
          return;
        }
        filtradas.forEach(emp => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'w-full text-left px-4 py-2 hover:bg-white/10 transition text-white border-b border-white/5 last:border-b-0';
          item.innerHTML = `
            <div class="font-medium">${escapeHtml(emp.nome)}</div>
            <div class="text-xs text-white/60">${emp.cnpj ? 'üßæ ' + escapeHtml(emp.cnpj) : ''} ${emp.email ? 'üìß ' + escapeHtml(emp.email) : ''}</div>
          `;
          item.addEventListener('click', (ev) => {
            ev.preventDefault();
            selecionarEmpresa(emp);
          });
          $dropdownEmpresas.appendChild(item);
        });
        $dropdownEmpresas.classList.remove('hidden');
      }

      function selecionarEmpresa(empresa) {
        empresaSelecionada = empresa;
        if ($inpEmpresa) $inpEmpresa.value = empresa.nome;
        if ($dropdownEmpresas) $dropdownEmpresas.classList.add('hidden');
        if ($empresaSelecionadaDiv) $empresaSelecionadaDiv.classList.remove('hidden');
        if ($empresaSelecionadaNome) $empresaSelecionadaNome.textContent = empresa.nome;
        syncPreview();
      }

      function getEmpresaSelecionada() {
        return empresaSelecionada;
      }

      // Clientes
      let cacheClientes = [];
      let clienteSelecionado = null;

      async function carregarClientes() {
        try {
          const res = await fetch(`${API_BASE_URL}/clientes/`, { credentials: 'include' });
          if (!res.ok) { showMsg('N√£o foi poss√≠vel carregar clientes', false); $warnCliente.classList.remove('hidden'); return; }
          const data = await res.json();
          cacheClientes = data.clientes || [];
          $warnCliente.classList.toggle('hidden', cacheClientes.length > 0);
        } catch (err) { console.error(err); showMsg('Erro ao carregar clientes', false); $warnCliente.classList.remove('hidden'); }
      }

      function filtrarClientes(termo) {
        if (!termo.trim()) return [];
        const q = termo.trim().toLowerCase();
        return cacheClientes.filter(c => 
          c.nome.toLowerCase().includes(q) || 
          (c.telefone && c.telefone.toLowerCase().includes(q)) ||
          (c.email && c.email.toLowerCase().includes(q))
        );
      }

      function renderDropdownClientes(termo) {
        const filtrados = filtrarClientes(termo);
        $dropdownClientes.innerHTML = '';
        if (filtrados.length === 0) {
          $dropdownClientes.classList.add('hidden');
          return;
        }
        filtrados.forEach(c => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'w-full text-left px-4 py-2 hover:bg-white/10 transition text-white border-b border-white/5 last:border-b-0';
          item.innerHTML = `
            <div class="font-medium">${escapeHtml(c.nome)}</div>
            <div class="text-xs text-white/60">${c.telefone ? 'üìû ' + escapeHtml(c.telefone) : ''} ${c.email ? 'üìß ' + escapeHtml(c.email) : ''}</div>
          `;
          item.addEventListener('click', (e) => {
            e.preventDefault();
            selecionarCliente(c);
          });
          $dropdownClientes.appendChild(item);
        });
        $dropdownClientes.classList.remove('hidden');
      }

      function selecionarCliente(cliente) {
        clienteSelecionado = cliente;
        $inpCliente.value = cliente.nome;
        $dropdownClientes.classList.add('hidden');
        $clienteSelecionadoDiv.classList.remove('hidden');
        $clienteSelecionadoNome.textContent = cliente.nome;
        syncPreview();
      }

      function getClienteSelecionado() {
        return clienteSelecionado;
      }

      // Servi√ßos
      let cacheServicos = [];
      async function carregarServicos() {
        try {
          const res = await fetch(`${API_BASE_URL}/servicos/`, { credentials: 'include' });
          if (!res.ok) { showMsg('N√£o foi poss√≠vel carregar servi√ßos', false); $warnServ.classList.remove('hidden'); return; }
          const data = await res.json(); cacheServicos = data.servicos || []; renderServicos(); $warnServ.classList.toggle('hidden', cacheServicos.length > 0);
        } catch (err) { console.error(err); showMsg('Erro ao carregar servi√ßos', false); $warnServ.classList.remove('hidden'); }
      }
      function renderServicos() { const q = (document.getElementById('inp-busca-serv')?.value || '').trim().toLowerCase(); const list = cacheServicos.filter(s => !q || s.nome.toLowerCase().includes(q) || (s.descricao || '').toLowerCase().includes(q)); $listaServ.innerHTML = ''; list.forEach(s => { const card = document.createElement('label'); card.className = 'flex items-center gap-3 rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/[0.07]'; card.innerHTML = `<input type="checkbox" class="form-checkbox rounded" data-id="${s.id_servicos}" /> <div class="flex-1"><p class="text-white font-medium leading-tight">${escapeHtml(s.nome)}</p><p class="text-white/70 text-sm line-clamp-2">${escapeHtml(s.descricao || 'Sem descri√ß√£o')}</p></div><div class="text-right"><p class="text-white font-semibold">${moeda(s.valor)}</p></div>`; $listaServ.appendChild(card); }); bindServicoChecks(); }
      function bindServicoChecks() { $listaServ.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', syncPreview)); }
      function getServicosSelecionados() { const ids = Array.from($listaServ.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.getAttribute('data-id')); return cacheServicos.filter(s => ids.includes(String(s.id_servicos))); }

      // Preview
      function syncPreview() { 
        const empresa = getEmpresaSelecionada();
        if ($prevEmpresa) $prevEmpresa.textContent = empresa ? empresa.nome : '‚Äî';
        const cliente = getClienteSelecionado(); 
        if (cliente) { 
          $clienteNome.textContent = cliente.nome; 
          $clienteTelefone.textContent = cliente.telefone || '‚Äî'; 
          $clienteEmail.textContent = cliente.email || '‚Äî'; 
          $clienteEndereco.textContent = cliente.endereco || '‚Äî'; 
          $prevCliente.textContent = cliente.nome; 
        } else { 
          $clienteNome.textContent = '‚Äî'; 
          $clienteTelefone.textContent = '‚Äî'; 
          $clienteEmail.textContent = '‚Äî'; 
          $clienteEndereco.textContent = '‚Äî'; 
          $prevCliente.textContent = '‚Äî'; 
        } 
        const selecionados = getServicosSelecionados(); 
        $prevQtd.textContent = selecionados.length; 
        const total = selecionados.reduce((acc, s) => acc + Number(s.valor || 0), 0); 
        $prevTotal.textContent = moeda(total); 
        $tbodyPrev.innerHTML = ''; 
        selecionados.forEach(s => { 
          const tr = document.createElement('tr'); 
          tr.innerHTML = `<td class="px-4 py-2">${escapeHtml(s.nome)}</td><td class="px-4 py-2">${escapeHtml(s.descricao || '-')}</td><td class="px-4 py-2 text-right">${moeda(s.valor)}</td>`; 
          $tbodyPrev.appendChild(tr); 
        }); 
      }

      // Gerar PDF
      async function gerarPDF() {
        const empresa = getEmpresaSelecionada();
        const cliente = getClienteSelecionado(); 
        const selecionados = getServicosSelecionados(); 
        if (!empresa) { showMsg('Selecione a empresa que emitir√° o or√ßamento.', false); $inpEmpresa?.focus(); return; }
        if (!cliente) { showMsg('Selecione um cliente.', false); $inpCliente.focus(); return; } 
        if (selecionados.length === 0) { showMsg('Selecione ao menos um servi√ßo.', false); return; }
        $btnPdf.disabled = true; 
        $btnPdf.textContent = 'Gerando...'; 
        try { 
          const itens = selecionados.map(s => ({ id_servico: s.id_servicos, quantidade: 1 }));
          const payload = { id_cliente: cliente.id_cliente, id_empresa: empresa.id_empresa, itens };
          const res = await fetch(`${API_BASE_URL}/orcamentos/`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload) }); 
          const data = await res.json(); 
          if (!res.ok) { showMsg(data.erro || 'Erro ao criar or√ßamento', false); return; } 
          const idOrc = data.orcamento?.id_orcamento; 
          if (!idOrc) { showMsg('Resposta inesperada do servidor', false); return; } 
          const pdfRes = await fetch(`${API_BASE_URL}/orcamentos/${idOrc}/pdf`, { credentials: 'include' }); 
          if (!pdfRes.ok) { const err = await pdfRes.json().catch(() => ({ erro: 'Erro ao gerar PDF' })); showMsg(err.erro || 'Erro ao gerar PDF', false); return; } 
          const blob = await pdfRes.blob(); 
          const url = URL.createObjectURL(blob); 
          const a = document.createElement('a'); a.href = url; a.download = `orcamento_${idOrc}.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showMsg('PDF gerado com sucesso!'); 
        } catch (err) { 
          console.error(err); 
          showMsg('Erro de conex√£o. Verifique se o servidor est√° rodando.', false); 
        } finally { 
          $btnPdf.disabled = false; 
          $btnPdf.textContent = 'Gerar PDF'; 
        } 
      }

      // Marca o item ativo no menu comparando o √∫ltimo segmento da URL
      (function () {
        const currentLast = (location.pathname || '').split('/').pop() || '';
        document.querySelectorAll('#sidebar .menu-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          const hrefLast = href.split('/').pop() || '';
          if (href === location.pathname || hrefLast === currentLast) {
            a.classList.add('bg-[#243647]', 'ring-1', 'ring-white/10');
          }
        });
      })();
      
      $inpEmpresa?.addEventListener('input', (e) => {
        const termo = e.target.value;
        if (termo.trim()) {
          renderDropdownEmpresas(termo);
        } else {
          $dropdownEmpresas?.classList.add('hidden');
        }
      });

      $inpEmpresa?.addEventListener('focus', (e) => {
        if (e.target.value.trim()) {
          renderDropdownEmpresas(e.target.value);
        } else if (cacheEmpresas.length > 0) {
          renderDropdownEmpresas('');
        }
      });

      $inpCliente.addEventListener('input', (e) => {
        const termo = e.target.value;
        if (termo.trim()) {
          renderDropdownClientes(termo);
        } else {
          $dropdownClientes.classList.add('hidden');
        }
      });

      $inpCliente.addEventListener('focus', (e) => {
        if (e.target.value.trim()) {
          renderDropdownClientes(e.target.value);
        }
      });

      document.addEventListener('click', (e) => {
        if ($inpEmpresa && !$inpEmpresa.contains(e.target) && !$dropdownEmpresas?.contains(e.target)) {
          $dropdownEmpresas?.classList.add('hidden');
        }
        if (!$inpCliente.contains(e.target) && !$dropdownClientes.contains(e.target)) {
          $dropdownClientes.classList.add('hidden');
        }
      });

      document.getElementById('inp-busca-serv')?.addEventListener('input', () => { renderServicos(); syncPreview(); });
      $btnPdf.addEventListener('click', gerarPDF);

      // Init
      carregarEmpresas();
      carregarClientes();
      carregarServicos();
      setTimeout(syncPreview, 250);
    </script>
  </body>
</html>
