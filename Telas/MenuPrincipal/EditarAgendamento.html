<!DOCTYPE html>
<html lang="pt-br" class="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planejador de Or√ßamento ‚Äî Editar Agendamento</title>

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        darkMode: 'class',
        theme: { extend: {} }
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  </head>

  <body class="bg-[#111a22] dark:bg-[#0a1015] transition-colors duration-300" style='font-family: Inter, "Noto Sans", sans-serif'>
  <script src="../js/auth-protection.js"></script>
  <div class="relative flex min-h-screen w-full overflow-x-hidden">
      <!-- Sidebar -->
      <aside class="w-[310px] shrink-0 bg-[#1a2a38]/95 border-r border-white/10 shadow-[0_0_0_1px_rgba(255,255,255,0.04),0_10px_30px_rgba(0,0,0,0.35)] backdrop-blur supports-[backdrop-filter]:backdrop-blur sticky top-0 h-screen">
        <div class="p-5 flex flex-col h-full">
          <div class="flex flex-col items-center gap-3">
            <div id="avatarPreview" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-24 w-24 ring-2 ring-white/10" style='background-image:url("../imagens/usuario.jpg");'></div>
            <div class="text-center">
              <p class="text-white text-lg font-bold leading-tight" id="nomeTopo">Usu√°rio exemplo</p>
              <p class="text-[#b9cee3] text-sm" id="statusTopo">Online</p>
            </div>
            <a href="/MenuPrincipal/TelaEditarPerfil.html" class="mt-1 inline-flex items-center justify-center h-9 px-4 rounded-lg bg-[#1773cf] text-white text-sm font-semibold hover:bg-[#1773cf]/90 transition">Editar Perfil</a>
          </div>

          <div class="mt-6">
            <h1 class="text-white text-sm font-medium">Planejador de Or√ßamento</h1>
            <p class="text-[#9fbbd4] text-xs">v1.0</p>
          </div>

          <nav class="mt-4 grid gap-1" id="sidebar">
            <a href="/MenuPrincipal/TelaMenuPrincipal.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 256 256" fill="currentColor" aria-hidden="true">
                  <path d="M218.83,103.3,141.17,33.33a16,16,0,0,0-22.34,0L37.17,103.3A16,16,0,0,0,32,114.64V208a16,16,0,0,0,16,16H96a8,8,0,0,0,8-8V160h48v56a8,8,0,0,0,8,8h48a16,16,0,0,0,16-16V114.64A16,16,0,0,0,218.83,103.3Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Home</span>
            </a>

            <a href="RegistrarCliente.html" class="menu-item group text-left flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M239.73,208H224V96a16,16,0,0,0-16-16H164a4,4,0,0,0-4,4V208H144V32.41a16.43,16.43,0,0,0-6.16-13,16,16,0,0,0-18.72-.69L39.12,72A16,16,0,0,0,32,85.34V208H16.27A8,8,0,0,0,8,215.47,8,8,0,0,0,16,224H240a8,8,0,0,0,8-8.53A8,8,0,0,0,239.73,208Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Registrar cliente</span>
            </a>

            <a href="/MenuPrincipal/RegistrarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Registrar servi√ßo</span>
            </a>

            <a href="/MenuPrincipal/AgendarServico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg bg-[#243647] ring-1 ring-white/10">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Agendar servi√ßo</span>
            </a>

            <a href="/MenuPrincipal/VerHistorico.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 5a1 1 0 0 0-2 0v5c0 .265.105.52.293.707l3 3a1 1 0 1 0 1.414-1.414L13 11.586V7z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Ver hist√≥rico</span>
            </a>

            <a href="/MenuPrincipal/CriarOrcamento.html" class="menu-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition">
              <span class="text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"/>
                </svg>
              </span>
              <span class="text-white text-sm font-medium">Criar plano de or√ßamento</span>
            </a>
          </nav>

          <div class="mt-auto pt-4">
            <a href="/" data-logout="true" class="w-full inline-flex items-center justify-center h-10 px-4 rounded-lg bg-white/10 text-white font-semibold hover:bg-white/20 transition">Sair</a>
          </div>
        </div>
      </aside>

      <!-- Conte√∫do -->
      <main class="flex-1 max-w-[1100px] w-full mx-auto px-6 py-8">
        <div class="mb-6">
          <a href="/MenuPrincipal/AgendarServico.html" class="text-[#1773cf] hover:text-[#1773cf]/80 text-sm font-medium flex items-center gap-1">
            ‚Üê Voltar para Agendamentos
          </a>
        </div>

        <h2 class="text-white text-2xl font-bold">Editar Detalhes do Agendamento</h2>
        <p class="text-[#93adc8] mt-1">Atualize as informa√ß√µes do agendamento selecionado.</p>

        <!-- FORMUL√ÅRIO -->
        <div class="mt-6 grid max-w-2xl gap-6">
          <!-- INFORMA√á√ïES B√ÅSICAS -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üìã Informa√ß√µes B√°sicas</h3>
            <div class="grid gap-4">
              <div>
                <label class="text-white text-sm font-medium">Servi√ßo</label>
                <p id="info-servico" class="text-white/70 mt-1 text-sm">‚Äî</p>
              </div>
              <div>
                <label class="text-white text-sm font-medium">Descri√ß√£o do Servi√ßo</label>
                <p id="info-descricao" class="text-white/70 mt-1 text-sm">‚Äî</p>
              </div>
            </div>
          </div>

          <!-- DATA E HORA -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üìÖ Data e Hora</h3>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-white text-sm font-medium block mb-2">Data</label>
                <input id="inp-data" type="text" class="form-input h-10 rounded-lg border-none bg-[#243647] text-white w-full" placeholder="dd/mm/aaaa" />
              </div>
              <div>
                <label class="text-white text-sm font-medium block mb-2">Hora</label>
                <input id="inp-hora" type="time" class="form-input h-10 rounded-lg border-none bg-[#243647] text-white w-full" />
              </div>
            </div>
          </div>

          <!-- CLIENTE (OPCIONAL) -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üë§ Cliente <span class="text-[#93adc8] text-sm font-normal">(opcional)</span></h3>
            <div class="relative">
              <input 
                id="inp-cliente" 
                type="text" 
                placeholder="Procure o nome do cliente..." 
                class="form-input h-10 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8] w-full" 
              />
              <div id="dropdown-clientes" class="absolute top-full left-0 right-0 mt-1 bg-[#243647] border border-white/10 rounded-lg shadow-lg max-h-80 overflow-y-auto hidden z-50">
                <!-- preenchido via JS -->
              </div>
            </div>
            <div id="cliente-selecionado" class="text-xs text-white/70 mt-2 hidden">‚úì Cliente: <span id="cliente-selecionado-nome" class="text-white font-medium">‚Äî</span></div>
          </div>

          <!-- STATUS -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üîÑ Status</h3>
            <select id="sel-status" class="form-select h-10 rounded-lg border-none bg-[#243647] text-white w-full">
              <option value="Agendado">Agendado</option>
              <option value="Confirmado">Confirmado</option>
              <option value="Em Andamento">Em Andamento</option>
              <option value="Conclu√≠do">Conclu√≠do</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>

          <!-- OBSERVA√á√ïES -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üìù Observa√ß√µes e Notas</h3>
            <textarea id="inp-observacoes" placeholder="Adicione notas sobre o agendamento..." rows="4" class="form-textarea h-24 rounded-lg border-none bg-[#243647] text-white placeholder:text-[#93adc8] w-full"></textarea>
          </div>

          <!-- ENDERE√áO (SE CLIENTE SELECIONADO) -->
          <div id="secao-endereco" class="rounded-lg border border-white/10 bg-white/5 p-5 hidden">
            <h3 class="text-white font-semibold mb-4">üìç Local do Agendamento</h3>
            <input id="inp-endereco" type="text" placeholder="Endere√ßo completo..." class="form-input h-10 rounded-lg border-none bg-[#243647] text-white w-full placeholder:text-[#93adc8]" />
          </div>

          <!-- T√âCNICO RESPONS√ÅVEL -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üë®‚Äçüîß T√©cnico Respons√°vel <span class="text-[#93adc8] text-sm font-normal">(opcional)</span></h3>
            <input id="inp-tecnico" type="text" placeholder="Nome do t√©cnico..." class="form-input h-10 rounded-lg border-none bg-[#243647] text-white w-full placeholder:text-[#93adc8]" />
          </div>

          <!-- LEMBRETES -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üîî Lembretes e Notifica√ß√µes</h3>
            <div class="space-y-3">
              <label class="flex items-center gap-3 cursor-pointer">
                <input id="chk-lembrete-cliente" type="checkbox" class="form-checkbox rounded" />
                <span class="text-white text-sm">Enviar lembrete ao cliente 1 dia antes</span>
              </label>
              <label class="flex items-center gap-3 cursor-pointer">
                <input id="chk-lembrete-tecnico" type="checkbox" class="form-checkbox rounded" />
                <span class="text-white text-sm">Enviar lembrete ao t√©cnico 1 dia antes</span>
              </label>
              <label class="flex items-center gap-3 cursor-pointer">
                <input id="chk-confirmacao" type="checkbox" class="form-checkbox rounded" />
                <span class="text-white text-sm">Solicitar confirma√ß√£o do cliente</span>
              </label>
            </div>
          </div>

          <!-- RECORR√äNCIA -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <h3 class="text-white font-semibold mb-4">üîÅ Recorr√™ncia</h3>
            <select id="sel-recorrencia" class="form-select h-10 rounded-lg border-none bg-[#243647] text-white w-full">
              <option value="nenhuma">√önica (sem repeti√ß√£o)</option>
              <option value="semanal">Semanal</option>
              <option value="quinzenal">Quinzenal</option>
              <option value="mensal">Mensal</option>
              <option value="trimestral">Trimestral</option>
              <option value="anual">Anual</option>
            </select>
            <div id="recorrencia-info" class="text-xs text-white/60 mt-2 hidden">Criar√° um novo agendamento repetido at√© o final do per√≠odo selecionado.</div>
          </div>

          <!-- VALOR -->
          <div class="rounded-lg border border-white/10 bg-white/5 p-5">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-white text-sm font-medium">Valor do Servi√ßo</label>
                <p id="info-valor" class="text-white text-lg font-semibold mt-2">‚Äî</p>
              </div>
              <div>
                <label class="text-white text-sm font-medium">Data de Cria√ß√£o</label>
                <p id="info-criacao" class="text-white/70 text-sm mt-2">‚Äî</p>
              </div>
            </div>
          </div>

          <!-- A√á√ïES -->
          <div class="flex flex-wrap items-center justify-between gap-3">
            <p id="msg" class="text-sm text-white/70"></p>
            <div class="flex gap-2">
              <button id="btn-cancelar" class="h-10 px-4 rounded-lg bg-white/10 text-white font-bold hover:bg-white/20 transition">Cancelar</button>
              <button id="btn-salvar" class="h-10 px-4 rounded-lg bg-[#1773cf] text-white font-bold hover:bg-[#1773cf]/90 transition">Salvar Altera√ß√µes</button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="/js/auth-protection.js"></script>
    <script>
      // ===== VERIFICAR ID DO AGENDAMENTO NA URL =====
      const params = new URLSearchParams(location.search);
      const idAgendamento = params.get('id');

      if (!idAgendamento) {
        alert('ID do agendamento n√£o fornecido');
        location.href = '/MenuPrincipal/AgendarServico.html';
      }

      // ===== ELEMENTOS =====
      const $inpData = document.getElementById('inp-data');
      const $inpHora = document.getElementById('inp-hora');
      const $inpCliente = document.getElementById('inp-cliente');
      const $dropdownClientes = document.getElementById('dropdown-clientes');
      const $clienteSelecionadoDiv = document.getElementById('cliente-selecionado');
      const $clienteSelecionadoNome = document.getElementById('cliente-selecionado-nome');
      const $selStatus = document.getElementById('sel-status');
      const $inpObservacoes = document.getElementById('inp-observacoes');
      const $inpEndereco = document.getElementById('inp-endereco');
      const $secaoEndereco = document.getElementById('secao-endereco');
      const $inpTecnico = document.getElementById('inp-tecnico');
      const $chkLembreteCliente = document.getElementById('chk-lembrete-cliente');
      const $chkLembreteTecnico = document.getElementById('chk-lembrete-tecnico');
      const $chkConfirmacao = document.getElementById('chk-confirmacao');
      const $selRecorrencia = document.getElementById('sel-recorrencia');
      const $recorrenciaInfo = document.getElementById('recorrencia-info');
      const $infoServico = document.getElementById('info-servico');
      const $infoDescricao = document.getElementById('info-descricao');
      const $infoValor = document.getElementById('info-valor');
      const $infoCriacao = document.getElementById('info-criacao');
      const $btnSalvar = document.getElementById('btn-salvar');
      const $btnCancelar = document.getElementById('btn-cancelar');
      const $msg = document.getElementById('msg');
      const $sidebar = document.getElementById('sidebar');

      // ===== UTILS =====
      function showMsg(text, ok = true) {
        $msg.textContent = text;
        $msg.className = 'text-sm ' + (ok ? 'text-emerald-300' : 'text-red-300');
        setTimeout(() => { $msg.textContent = ''; $msg.className = 'text-sm text-white/70'; }, 2200);
      }

      function moeda(v) { 
        return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(Number(v||0)); 
      }

      function escapeHtml(s) { 
        return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
      }

      function fmtDataHora(iso){
        if (!iso) return '-';
        const d = new Date(iso);
        if (isNaN(d)) return '-';
        const dd = d.toLocaleDateString('pt-BR');
        const hh = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        return dd+' '+hh;
      }

      // ===== CLIENTES =====
      let cacheClientes = [];
      let clienteSelecionado = null;

      async function carregarClientes() {
        try {
          const res = await fetch(`${API_BASE_URL}/clientes/`, { credentials: 'include' });
          if (!res.ok) return;
          const data = await res.json();
          cacheClientes = data.clientes || [];
        } catch (err) { console.error(err); }
      }

      function filtrarClientes(termo) {
        if (!termo.trim()) return [];
        const q = termo.trim().toLowerCase();
        return cacheClientes.filter(c => 
          c.nome.toLowerCase().includes(q) || 
          (c.telefone && c.telefone.toLowerCase().includes(q)) ||
          (c.email && c.email.toLowerCase().includes(q))
        );
      }

      function renderDropdownClientes(termo) {
        const filtrados = filtrarClientes(termo);
        $dropdownClientes.innerHTML = '';
        if (filtrados.length === 0) {
          $dropdownClientes.classList.add('hidden');
          return;
        }
        filtrados.forEach(c => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'w-full text-left px-4 py-2 hover:bg-white/10 transition text-white border-b border-white/5 last:border-b-0';
          item.innerHTML = `
            <div class="font-medium">${escapeHtml(c.nome)}</div>
            <div class="text-xs text-white/60">${c.telefone ? 'üìû ' + escapeHtml(c.telefone) : ''} ${c.email ? 'üìß ' + escapeHtml(c.email) : ''}</div>
          `;
          item.addEventListener('click', (e) => {
            e.preventDefault();
            selecionarCliente(c);
          });
          $dropdownClientes.appendChild(item);
        });
        $dropdownClientes.classList.remove('hidden');
      }

      function selecionarCliente(cliente) {
        clienteSelecionado = cliente;
        $inpCliente.value = cliente.nome;
        $dropdownClientes.classList.add('hidden');
        $clienteSelecionadoDiv.classList.remove('hidden');
        $clienteSelecionadoNome.textContent = cliente.nome;
        if (cliente.endereco) {
          $inpEndereco.value = cliente.endereco;
          $secaoEndereco.classList.remove('hidden');
        }
      }

      // ===== CARREGAR AGENDAMENTO =====
      async function carregarAgendamento() {
        try {
          const res = await fetch(`${API_BASE_URL}/agendamentos/${idAgendamento}`, { credentials: 'include' });
          if (!res.ok) {
            showMsg('Agendamento n√£o encontrado', false);
            setTimeout(() => location.href = '/MenuPrincipal/AgendarServico.html', 1500);
            return;
          }
          const data = await res.json();
          const ag = data.agendamento;

          // Preenche informa√ß√µes
          $infoServico.textContent = ag.servico_nome || '‚Äî';
          $infoDescricao.textContent = ag.servico_descricao || '‚Äî';
          $infoValor.textContent = moeda(ag.valor);
          $infoCriacao.textContent = fmtDataHora(ag.created_at);

          // Preenche data/hora
          if (ag.data_hora) {
            const d = new Date(ag.data_hora);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const ano = d.getFullYear();
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            $inpData.value = `${dia}/${mes}/${ano}`;
            $inpHora.value = `${hh}:${mm}`;
          }

          // Status
          $selStatus.value = ag.status || 'Agendado';

          // Observa√ß√µes
          $inpObservacoes.value = ag.observacoes || '';

        } catch (err) {
          console.error(err);
          showMsg('Erro ao carregar agendamento', false);
        }
      }

      // ===== ATUALIZAR AGENDAMENTO =====
      async function salvarAlteracoes() {
        const dataBr = $inpData.value;
        if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dataBr)) {
          showMsg('Formato de data inv√°lido (dd/mm/aaaa)', false);
          return;
        }
        const [dia, mes, ano] = dataBr.split('/');
        const data = `${ano}-${mes}-${dia}`;
        const hora = $inpHora.value;

        if (!data) { showMsg('Informe a data', false); return; }
        if (!hora) { showMsg('Informe a hora', false); return; }

        const dataHoraISO = `${data}T${hora}:00`;

        const payload = {
          data_hora: dataHoraISO,
          status: $selStatus.value,
          observacoes: $inpObservacoes.value,
          endereco: $inpEndereco.value || null,
          tecnico: $inpTecnico.value || null,
          id_cliente: clienteSelecionado ? clienteSelecionado.id_cliente : null,
          lembrete_cliente: $chkLembreteCliente.checked,
          lembrete_tecnico: $chkLembreteTecnico.checked,
          solicitar_confirmacao: $chkConfirmacao.checked,
          recorrencia: $selRecorrencia.value
        };

        try {
          $btnSalvar.disabled = true;
          $btnSalvar.textContent = 'Salvando...';

          const res = await fetch(`${API_BASE_URL}/agendamentos/${idAgendamento}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const error = await res.json();
            showMsg(error.erro || 'Erro ao atualizar agendamento', false);
            return;
          }

          showMsg('Agendamento atualizado com sucesso!');
          setTimeout(() => location.href = '/MenuPrincipal/AgendarServico.html', 1500);
        } catch (err) {
          console.error(err);
          showMsg('Erro de conex√£o', false);
        } finally {
          $btnSalvar.disabled = false;
          $btnSalvar.textContent = 'Salvar Altera√ß√µes';
        }
      }

      // ===== EVENT LISTENERS =====
      $inpCliente.addEventListener('input', (e) => {
        if (e.target.value.trim()) {
          renderDropdownClientes(e.target.value);
        } else {
          $dropdownClientes.classList.add('hidden');
        }
      });

      $inpCliente.addEventListener('focus', (e) => {
        if (e.target.value.trim()) {
          renderDropdownClientes(e.target.value);
        }
      });

      document.addEventListener('click', (e) => {
        if (!$inpCliente.contains(e.target) && !$dropdownClientes.contains(e.target)) {
          $dropdownClientes.classList.add('hidden');
        }
      });

      $selRecorrencia.addEventListener('change', (e) => {
        $recorrenciaInfo.classList.toggle('hidden', e.target.value === 'nenhuma');
      });

      $btnSalvar.addEventListener('click', salvarAlteracoes);
      $btnCancelar.addEventListener('click', () => location.href = '/MenuPrincipal/AgendarServico.html');

      // ===== FLATPICKR =====
      flatpickr($inpData, {
        dateFormat: "d/m/Y",
        locale: {
          firstDayOfWeek: 0,
          weekdays: {
            shorthand: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"],
            longhand: ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"],
          },
          months: {
            shorthand: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
            longhand: ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
          },
        },
      });

      // ===== MENU ATIVO =====
      (function () {
        const currentLast = (location.pathname || '').split('/').pop() || '';
        document.querySelectorAll('#sidebar .menu-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          const hrefLast = href.split('/').pop() || '';
          if (href === location.pathname || hrefLast === currentLast) a.classList.add('bg-[#243647]', 'ring-1', 'ring-white/10');
        });
      })();

      // ===== INIT =====
      carregarClientes();
      carregarAgendamento();
    </script>
  </body>
</html>
